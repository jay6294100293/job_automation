{% extends 'dashboard/../base_dashboard.html' %}
{% load static %}

{% block title %}Job List - Job Automation{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="display-6 fw-bold text-white">
                        <i class="fas fa-list text-primary"></i> Job Opportunities
                    </h2>
                    <p class="text-muted-white">Browse and manage your job applications</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{% url 'jobs:applications' %}" class="btn btn-outline-primary">
                        <i class="fas fa-project-diagram"></i> Pipeline View
                    </a>
                    <a href="{% url 'jobs:job_list' %}" class="btn btn-primary active">
                        <i class="fas fa-list"></i> List View
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4" >
        <div class="col-md-3">
            <div class="card stats-card bg-dark-card border-primary">
                <div class="card-body text-center">
                    <h3 class="text-primary">{{ total_jobs }}</h3>
                    <p class="text-muted mb-0 btn-close-white">Total Jobs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-dark-card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success">{{ applied_jobs }}</h3>
                    <p class="text-muted mb-0 btn-close-white">Applied</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-dark-card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning">{{ interviews_count }}</h3>
                    <p class="text-muted mb-0 btn-close-white">Interviews</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-dark-card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info ">{{ offers_count }}</h3>
                    <p class="text-muted mb-0 btn-close-white">Offers</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm bg-dark-card">
                <div class="card-header bg-dark-header">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-filter text-info"></i> Filters & Search
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" id="filterForm" class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label text-white">Status</label>
                            <select name="status" class="form-select bg-dark-input text-white border-secondary">
                                <option value="">All Statuses</option>
                                <option value="found" {% if request.GET.status == 'found' %}selected{% endif %}>Found</option>
                                <option value="applied" {% if request.GET.status == 'applied' %}selected{% endif %}>Applied</option>
                                <option value="responded" {% if request.GET.status == 'responded' %}selected{% endif %}>Responded</option>
                                <option value="interview" {% if request.GET.status == 'interview' %}selected{% endif %}>Interview</option>
                                <option value="offer" {% if request.GET.status == 'offer' %}selected{% endif %}>Offer</option>
                                <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white">Urgency</label>
                            <select name="urgency" class="form-select bg-dark-input text-white border-secondary">
                                <option value="">All Urgency</option>
                                <option value="urgent" {% if request.GET.urgency == 'urgent' %}selected{% endif %}>Urgent</option>
                                <option value="high" {% if request.GET.urgency == 'high' %}selected{% endif %}>High</option>
                                <option value="medium" {% if request.GET.urgency == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="low" {% if request.GET.urgency == 'low' %}selected{% endif %}>Low</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white">Remote Option</label>
                            <select name="remote" class="form-select bg-dark-input text-white border-secondary">
                                <option value="">All Types</option>
                                <option value="remote" {% if request.GET.remote == 'remote' %}selected{% endif %}>Remote</option>
                                <option value="hybrid" {% if request.GET.remote == 'hybrid' %}selected{% endif %}>Hybrid</option>
                                <option value="onsite" {% if request.GET.remote == 'onsite' %}selected{% endif %}>On-site</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white">Date Posted</label>
                            <select name="date_range" class="form-select bg-dark-input text-white border-secondary">
                                <option value="">All Time</option>
                                <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                                <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
                                <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-white">Search</label>
                            <div class="input-group">
                                <input type="text" name="search" class="form-control bg-dark-input text-white border-secondary"
                                       placeholder="Job title, company, or keywords..."
                                       value="{{ request.GET.search }}">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-auto"> {# Changed from col-md-1 to col-md-auto for flexible layout #}
                            <label class="form-label">&nbsp;</label>
                            <a href="{% url 'jobs:job_list' %}" class="btn btn-outline-secondary d-block text-white">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm bg-dark-card">
                <div class="card-body py-2">
                    <form method="post" action="{% url 'jobs:bulk_action' %}" id="bulkForm">
                        {% csrf_token %}
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                    <label class="form-check-label fw-bold text-white" for="selectAll">
                                        Select All
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select name="action" class="form-select form-select-sm bg-dark-input text-white border-secondary" id="bulkAction">
                                    <option value="">Choose action...</option>
                                    <option value="mark_applied">Mark as Applied</option>
                                    <option value="send_followup">Send Follow-up</option>
                                    <option value="download_docs">Download Documents</option>
                                    <option value="update_status">Update Status</option>
                                    <option value="export_data">Export Data</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-sm btn-success" id="executeButton" disabled>
                                    <i class="fas fa-play"></i> Execute
                                </button>
                            </div>
                            <div class="col-md-5 text-end">
                                <span class="text-muted small">
                                    <span id="selectedCount">0</span> items selected
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm bg-dark-card">
                <div class="card-header bg-dark-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-briefcase text-primary"></i>
                        Job Applications
                        <span class="badge bg-primary">{{ jobs.count }}</span>
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="sort" id="sort-date" value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}checked{% endif %}>
                        <label class="btn btn-outline-secondary text-white" for="sort-date">Latest</label>

                        <input type="radio" class="btn-check" name="sort" id="sort-match" value="-match_percentage">
                        <label class="btn btn-outline-secondary text-white" for="sort-match">Best Match</label>

                        <input type="radio" class="btn-check" name="sort" id="sort-company" value="company_name">
                        <label class="btn btn-outline-secondary text-white" for="sort-company">Company</label>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if jobs %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 table-dark-theme">
                                <thead class="table-light-dark">
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" id="selectAllTable" class="form-check-input">
                                        </th>
                                        <th class="text-white">Job Details</th>
                                        <th class="text-white">Company</th>
                                        <th class="text-white">Location</th>
                                        <th class="text-white">Salary</th>
                                        <th class="text-white">Status</th>
                                        <th class="text-white">Match</th>
                                        <th class="text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in jobs %}
                                    <tr class="job-row" data-job-id="{{ job.id }}">
                                        <td>
                                            <input type="checkbox" name="selected_jobs" value="{{ job.id }}"
                                                   class="form-check-input job-checkbox bg-dark-input border-secondary">
                                        </td>
                                        <td>
                                            <div class="job-details">
                                                <h6 class="mb-1">
                                                    <a href="{% url 'jobs:application_detail' job.pk %}"
                                                       class="text-decoration-none job-title">
                                                        {{ job.job_title }}
                                                    </a>
                                                </h6>
                                                <div class="job-meta">
                                                    {% if job.urgency_level != 'medium' %}
                                                        <span class="badge bg-{% if job.urgency_level == 'urgent' %}danger{% elif job.urgency_level == 'high' %}warning{% else %}secondary{% endif %} me-1">
                                                            {{ job.get_urgency_level_display }}
                                                        </span>
                                                    {% endif %}
                                                    {% if job.remote_option %}
                                                        <span class="badge bg-success me-1">{{ job.remote_option|title }}</span>
                                                    {% endif %}
                                                    {% if job.documents_generated %}
                                                        <span class="badge bg-info me-1">
                                                            <i class="fas fa-file-alt"></i> Docs Ready
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <small class="text-muted">
                                                    <i class="fas fa-clock"></i> Posted {{ job.created_at|timesince }} ago
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="company-info text-white">
                                                <strong>{{ job.company_name }}</strong>
                                                {% if job.company_rating %}
                                                    <div class="company-rating">
                                                        {% for i in "12345" %}
                                                            <i class="fas fa-star {% if forloop.counter <= job.company_rating %}text-warning{% else %}text-muted{% endif %} small"></i>
                                                        {% endfor %}
                                                        <small class="text-muted">({{ job.company_rating }})</small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="location-info text-white">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                {{ job.location|default:"Not specified" }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="salary-info">
                                                {% if job.salary_range %}
                                                    <strong class="text-success">{{ job.salary_range }}</strong>
                                                {% else %}
                                                    <span class="text-muted">Not specified</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if job.application_status == 'found' %}secondary{% elif job.application_status == 'applied' %}primary{% elif job.application_status == 'responded' %}success{% elif job.application_status == 'interview' %}warning{% elif job.application_status == 'offer' %}info{% elif job.application_status == 'rejected' %}danger{% else %}dark{% endif %} status-badge"
                                                  data-job-id="{{ job.id }}">
                                                {{ job.get_application_status_display }}
                                            </span>
                                            {% if job.applied_date %}
                                                <br><small class="text-muted">{{ job.applied_date|date:"M d" }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if job.match_percentage %}
                                                <div class="match-score">
                                                    <div class="progress" style="height: 8px;">
                                                        <div class="progress-bar bg-{% if job.match_percentage >= 80 %}success{% elif job.match_percentage >= 60 %}warning{% else %}danger{% endif %}"
                                                             style="width: {{ job.match_percentage }}%">
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">{{ job.match_percentage }}%</small>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle text-white"
                                                        data-bs-toggle="dropdown">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-dark">
                                                    <li>
                                                        <a class="dropdown-item text-white" href="{% url 'jobs:application_detail' job.pk %}">
                                                            <i class="fas fa-eye"></i> View Details
                                                        </a>
                                                    </li>
                                                    {% if job.job_url %}
                                                    <li>
                                                        <a class="dropdown-item text-white" href="{{ job.job_url }}" target="_blank">
                                                            <i class="fas fa-external-link-alt"></i> Original Post
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    {% if job.application_status == 'found' %}
                                                    <li>
                                                        <a class="dropdown-item text-white" href="#" onclick="markAsApplied({{ job.id }})">
                                                            <i class="fas fa-paper-plane"></i> Mark Applied
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    {% if job.application_status == 'applied' or job.application_status == 'responded' %}
                                                    <li>
                                                        <a class="dropdown-item text-white" href="#" onclick="sendFollowup({{ job.id }})">
                                                            <i class="fas fa-envelope"></i> Send Follow-up
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    {% if job.documents_generated %}
                                                    <li>
                                                        <a class="dropdown-item text-white" href="{% url 'documents:download' job.id %}">
                                                            <i class="fas fa-download"></i> Download Docs
                                                        </a>
                                                    </li>
                                                    {% else %}
                                                    <li>
                                                        <a class="dropdown-item text-white" href="#" onclick="generateDocuments({{ job.id }})">
                                                            <i class="fas fa-file-alt"></i> Generate Docs
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-white" href="#" onclick="updateStatus({{ job.id }})">
                                                            <i class="fas fa-edit"></i> Update Status
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" onclick="withdrawApplication({{ job.id }})">
                                                            <i class="fas fa-times"></i> Withdraw
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if is_paginated %}
                        <div class="card-footer bg-dark-header">
                            <nav aria-label="Job list pagination">
                                <ul class="pagination pagination-sm justify-content-center mb-0">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link bg-dark-input text-white border-secondary" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                                &laquo; First
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link bg-dark-input text-white border-secondary" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                                Previous
                                            </a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link bg-primary border-primary">
                                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link bg-dark-input text-white border-secondary" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                                Next
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link bg-dark-input text-white border-secondary" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                                Last &raquo;
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        {% endif %}

                    {% else %}
                        <div class="text-center py-5">
                            {% if request.GET.search or request.GET.status %}
                                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                                <h4 class="text-white">No Jobs Found</h4>
                                <p class="text-muted">No jobs match your current filters.</p>
                                <a href="{% url 'jobs:job_list' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-times"></i> Clear Filters
                                </a>
                            {% else %}
                                <i class="fas fa-briefcase fa-4x text-muted mb-3"></i>
                                <h4 class="text-white">No Jobs Yet</h4>
                                <p class="text-white ">Start your first job search to see opportunities here.</p>
                                <a href="{% url 'jobs:search_config' %}" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Start Job Search
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark-card text-white">
            <div class="modal-header bg-dark-header">
                <h5 class="modal-title">Update Job Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <input type="hidden" id="jobId" name="job_id">
                    <div class="form-group mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select bg-dark-input text-white border-secondary" id="newStatus" name="status" required>
                            <option value="found">Found</option>
                            <option value="applied">Applied</option>
                            <option value="responded">Responded</option>
                            <option value="interview">Interview Scheduled</option>
                            <option value="offer">Offer Received</option>
                            <option value="hired">Hired</option>
                            <option value="rejected">Rejected</option>
                            <option value="withdrawn">Withdrawn</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control bg-dark-input text-white border-secondary" id="statusNotes" name="notes" rows="3"
                                  placeholder="Add any relevant notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-dark-header">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Custom styles specific to job_list.html, using variables from base_dashboard.html */

/* Ensure the main content background matches the primary background variable */
.dashboard-content {
    background-color: var(--bg-primary);
}

/* Specific card styles to align with the elegant dark theme */
.bg-dark-card {
    background-color: var(--bg-secondary) !important;
    border: 1px solid var(--border-primary) !important;
    box-shadow: var(--shadow-md) !important;
}

.bg-dark-header {
    background-color: var(--bg-tertiary) !important;
    border-bottom: 1px solid var(--border-primary) !important;
    color: var(--text-primary) !important;
}

/* Form control and select styling */
.form-control, .form-select {
    background-color: var(--bg-secondary); /* Use secondary background for inputs */
    color: #FFFFFF !important; /* Force white text for visibility */
    border-color: var(--border-primary);
}

.form-control::placeholder {
    color: var(--text-secondary); /* Placeholder matches muted text */
}

.form-control:focus, .form-select:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.35); /* Soft focus glow */
}

.bg-dark-input {
    background-color: var(--bg-secondary) !important;
    color: #FFFFFF !important;
}
.bg-dark-input option {
    background-color: var(--bg-secondary);
    color: #FFFFFF;
}

/* Stats cards - re-emphasize borders and shadows */
.stats-card {
    border-left: 4px solid;
    transition: all var(--transition-slow);
    box-shadow: var(--shadow-md); /* Use defined shadow */
}

.stats-card:hover {
    transform: translateY(-7px);
    box-shadow: var(--shadow-lg); /* Use stronger shadow on hover */
    background-color: color-mix(in srgb, var(--bg-secondary) 90%, #FFFFFF 5%) !important; /* Subtle highlight */
}

/* Table styling for dark theme */
.table-dark-theme {
    color: var(--text-primary);
    background-color: var(--bg-secondary);
}

.table-light-dark { /* Custom class for dark table header */
    background-color: var(--bg-tertiary) !important;
    color: var(--text-primary) !important;
    border-top: none;
    font-weight: 600;
}

.table-dark-theme th,
.table-dark-theme td {
    border-top: 1px solid var(--border-primary); /* Consistent border for cells */
}

.job-row:hover {
    background-color: color-mix(in srgb, var(--bg-secondary) 90%, var(--accent-primary) 5%) !important; /* Subtle accent hover */
}

.job-title {
    font-weight: 600;
    color: var(--link-accent); /* Use the new link accent color */
}

.job-title:hover {
    color: var(--link-accent-hover); /* Use the new link accent hover color */
    text-decoration: underline !important;
}

.job-meta .badge {
    font-size: 0.7rem;
    padding: 0.4em 0.6em;
    border-radius: 0.35rem;
    opacity: 0.9;
}

.match-score .progress {
    width: 60px;
    height: 6px !important;
    border-radius: 0.25rem;
    background-color: var(--border-primary); /* Background of progress bar track */
}

/* Buttons and dropdowns */
.btn-outline-primary {
    color: var(--accent-primary);
    border-color: var(--accent-primary);
    background-color: transparent;
    transition: all var(--transition-normal);
}

.btn-outline-primary:hover {
    background-color: var(--accent-primary);
    color: white;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

.btn-outline-secondary {
    color: var(--text-secondary); /* Use text-secondary for outline secondary */
    border-color: var(--border-primary);
    background-color: transparent;
    transition: all var(--transition-normal);
}
.btn-outline-secondary:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-primary);
}

.dropdown-menu {
    box-shadow: var(--shadow-lg);
    border: none;
    background-color: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.dropdown-menu-dark .dropdown-item {
    color: var(--text-primary);
    transition: all 0.15s ease;
}

.dropdown-menu-dark .dropdown-item:hover {
    background-color: var(--bg-tertiary);
    color: var(--accent-primary); /* Accent color on hover */
}

.dropdown-divider {
    border-top: 1px solid var(--border-primary);
}

/* Pagination */
.page-link {
    color: var(--link-accent); /* Pagination links match job title links */
    border-color: var(--border-primary);
    background-color: var(--bg-secondary);
    transition: all var(--transition-normal);
}

.page-link:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
    border-color: var(--border-primary);
}

.page-item.active .page-link {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

/* Modal styling for dark theme */
.modal-content {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
}

.modal-header {
    border-bottom: 1px solid var(--border-primary);
}

.modal-footer {
    border-top: 1px solid var(--border-primary);
}

.btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
    opacity: 0.7;
    transition: opacity 0.2s ease;
}
.btn-close:hover {
    opacity: 1;
}
.btn-close-white { /* Ensure this class still works if present */
    filter: invert(1) grayscale(100%) brightness(200%);
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }

    .job-meta .badge {
        font-size: 0.6rem;
        margin-bottom: 2px;
    }

    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.job-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateSelectedCount();
    updateExecuteButton();
});

document.getElementById('selectAllTable').addEventListener('change', function() {
    document.getElementById('selectAll').checked = this.checked;
    document.getElementById('selectAll').dispatchEvent(new Event('change'));
});

// Update selected count
function updateSelectedCount() {
    const selected = document.querySelectorAll('.job-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected;
}

// Update execute button state
function updateExecuteButton() {
    const selected = document.querySelectorAll('.job-checkbox:checked').length;
    const action = document.getElementById('bulkAction').value;
    document.getElementById('executeButton').disabled = selected === 0 || !action;
}

// Individual checkbox change
document.querySelectorAll('.job-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateSelectedCount();
        updateExecuteButton();

        // Update select all checkbox
        const total = document.querySelectorAll('.job-checkbox').length;
        const selected = document.querySelectorAll('.job-checkbox:checked').length;
        const selectAll = document.getElementById('selectAll');

        selectAll.checked = selected === total;
        selectAll.indeterminate = selected > 0 && selected < total;
    });
});

// Bulk action change
document.getElementById('bulkAction').addEventListener('change', updateExecuteButton);

// Auto-submit filters
document.querySelectorAll('input[name="sort"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            const form = document.getElementById('filterForm');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'sort';
            hiddenInput.value = this.value;
            form.appendChild(hiddenInput);
            form.submit();
        }
    });
});

// Quick action functions (ensure SweetAlert2 is correctly styled for dark theme)
function markAsApplied(jobId) {
    Swal.fire({
        title: 'Mark as Applied?',
        text: 'This will update the status and start follow-up tracking.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Mark Applied',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'swal2-dark-custom', // Use custom class
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            updateJobStatus(jobId, 'applied');
        }
    });
}

function sendFollowup(jobId) {
    Swal.fire({
        title: 'Send Follow-up?',
        text: 'This will send a follow-up email using your default template.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Send Follow-up',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'swal2-dark-custom',
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Placeholder for CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            $.post(`/followups/send/${jobId}/`, {
                csrfmiddlewaretoken: csrftoken
            }).done(function(data) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Follow-up email sent successfully.',
                    icon: 'success',
                    customClass: { popup: 'swal2-dark-custom' }
                });
                setTimeout(() => location.reload(), 1500);
            }).fail(function() {
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to send follow-up email.',
                    icon: 'error',
                    customClass: { popup: 'swal2-dark-custom' }
                });
            });
        }
    });
}

function generateDocuments(jobId) {
    Swal.fire({
        title: 'Generate Documents?',
        text: 'This will create personalized resume, cover letter, and other documents.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Generate Documents',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'swal2-dark-custom',
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Generating Documents...',
                text: 'Please wait while we create your personalized documents.',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                },
                customClass: { popup: 'swal2-dark-custom' }
            });

            // Simulate document generation
            setTimeout(() => {
                Swal.fire({
                    title: 'Success!',
                    text: 'Documents have been generated successfully.',
                    icon: 'success',
                    customClass: { popup: 'swal2-dark-custom' }
                });
                setTimeout(() => location.reload(), 1500);
            }, 3000);
        }
    });
}

function updateStatus(jobId) {
    document.getElementById('jobId').value = jobId;
    // Assuming you have jQuery for modal or use Bootstrap's JS directly
    const statusUpdateModal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
    statusUpdateModal.show();
}

function saveStatusUpdate() {
    const jobId = document.getElementById('jobId').value;
    const status = document.getElementById('newStatus').value;
    const notes = document.getElementById('statusNotes').value;

    updateJobStatus(jobId, status, notes);
    const statusUpdateModal = bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal'));
    statusUpdateModal.hide();
}

function updateJobStatus(jobId, status, notes = '') {
    // Placeholder for CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    $.ajax({
        url: `/jobs/applications/${jobId}/update-status/`,
        method: 'POST',
        data: {
            'status': status,
            'notes': notes,
            'csrfmiddlewaretoken': csrftoken
        },
        success: function(response) {
            if (response.success) {
                // Update the status badge in the table
                const statusBadge = document.querySelector(`[data-job-id="${jobId}"] .status-badge`);
                if (statusBadge) {
                    statusBadge.className = `badge status-badge bg-${getStatusColor(status)}`;
                    statusBadge.textContent = getStatusDisplay(status);
                }

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    icon: 'success',
                    title: 'Status updated successfully',
                    customClass: { popup: 'swal2-dark-toast-custom' } // Custom class for dark toast
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to update status',
                    icon: 'error',
                    customClass: { popup: 'swal2-dark-custom' }
                });
            }
        },
        error: function() {
            Swal.fire({
                title: 'Error!',
                text: 'Failed to update status',
                icon: 'error',
                customClass: { popup: 'swal2-dark-custom' }
            });
        }
    });
}

function withdrawApplication(jobId) {
    Swal.fire({
        title: 'Withdraw Application?',
        text: 'This will mark the application as withdrawn. This action can be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, withdraw',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc3545',
        customClass: {
            popup: 'swal2-dark-custom',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            updateJobStatus(jobId, 'withdrawn');
        }
    });
}

// Helper functions
function getStatusColor(status) {
    const colors = {
        'found': 'secondary',
        'applied': 'primary',
        'responded': 'success',
        'interview': 'warning',
        'offer': 'info',
        'hired': 'success',
        'rejected': 'danger',
        'withdrawn': 'dark'
    };
    return colors[status] || 'secondary';
}

function getStatusDisplay(status) {
    const displays = {
        'found': 'Found',
        'applied': 'Applied',
        'responded': 'Responded',
        'interview': 'Interview',
        'offer': 'Offer',
        'hired': 'Hired',
        'rejected': 'Rejected',
        'withdrawn': 'Withdrawn'
    };
    return displays[status] || status;
}

// Bulk form submission
document.getElementById('bulkForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const selected = document.querySelectorAll('.job-checkbox:checked').length;
    const action = document.getElementById('bulkAction').value;

    if (selected === 0) {
        Swal.fire({
            title: 'No Selection',
            text: 'Please select at least one job application.',
            icon: 'warning',
            customClass: { popup: 'swal2-dark-custom' }
        });
        return;
    }

    if (!action) {
        Swal.fire({
            title: 'No Action',
            text: 'Please select an action to perform.',
            icon: 'warning',
            customClass: { popup: 'swal2-dark-custom' }
        });
        return;
    }

    const actionText = document.getElementById('bulkAction').selectedOptions[0].text;

    Swal.fire({
        title: `${actionText}?`,
        text: `This will ${actionText.toLowerCase()} for ${selected} selected applications.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Proceed',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'swal2-dark-custom',
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            this.submit();
        }
    });
});

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Add custom styling for SweetAlert2 dark theme to ensure it matches
const style = document.createElement('style');
style.innerHTML = `
.swal2-dark-custom {
    background-color: var(--bg-secondary) !important; /* Match card background */
    color: var(--text-primary) !important;
    border: 1px solid var(--border-primary) !important;
    box-shadow: var(--shadow-lg) !important;
    border-radius: var(--radius-lg) !important;
}
.swal2-title {
    color: var(--text-primary) !important;
}
.swal2-html-container {
    color: var(--text-secondary) !important;
}
.swal2-styled.swal2-confirm {
    background-color: var(--accent-primary) !important;
    color: #fff !important;
    border: none !important;
}
.swal2-styled.swal2-cancel {
    background-color: var(--text-tertiary) !important; /* Use tertiary for cancel for a softer look */
    color: #fff !important;
    border: none !important;
}
.swal2-icon.swal2-success [class^=swal2-success-line][class$=long],
.swal2-icon.swal2-success [class^=swal2-success-line][class$=tip] {
    background-color: var(--success-500) !important;
}
.swal2-icon.swal2-warning {
    border-color: var(--warning-500) !important;
    color: var(--warning-500) !important;
}
.swal2-icon.swal2-error {
    border-color: var(--danger-500) !important;
    color: var(--danger-500) !important;
}
.swal2-icon.swal2-info {
    border-color: var(--info-500) !important;
    color: var(--info-500) !important;
}
.swal2-dark-toast-custom {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-primary) !important;
    box-shadow: var(--shadow-md) !important;
}
`;
document.head.appendChild(style);

// Auto-refresh functionality (optional)
let autoRefresh = false;
function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    if (autoRefresh) {
        setInterval(() => {
            if (autoRefresh) {
                location.reload();
            }
        }, 60000); // Refresh every minute
    }
}
</script>
{% endblock %}
